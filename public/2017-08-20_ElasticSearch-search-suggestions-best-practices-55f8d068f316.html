<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>ElasticSearch search suggestions best practices</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">ElasticSearch search suggestions best practices</h1>
</header>
<section data-field="subtitle" class="p-summary">
E-commerce platforms are heavily used by users and making sure that products are super easy to be found is crucial.
</section>
<section data-field="body" class="e-content">
<section name="a5c1" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="f040" id="f040" class="graf graf--h3 graf--leading graf--title">ElasticSearch search suggestions best practices</h3></div><div class="section-inner sectionLayout--outsetColumn"><figure name="f4b3" id="f4b3" class="graf graf--figure graf--layoutOutsetCenter graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1032px; max-height: 211px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 20.4%;"></div><img class="graf-image" data-image-id="1*-dcTolNmIyNJ0VwUrAszuA.png" data-width="1428" data-height="292" data-is-featured="true" src="https://cdn-images-1.medium.com/max/1200/1*-dcTolNmIyNJ0VwUrAszuA.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="85df" id="85df" class="graf graf--p graf-after--figure">E-commerce platforms are heavily used by users and making sure that products are super easy to be found is crucial.</p><p name="4ea5" id="4ea5" class="graf graf--p graf-after--p graf--trailing">I’ve been working in a company that handles a platform that provides access to 100Mill products, so we’ve dedicated some time and resources to make sure our search results and suggestions get better over time. of course, as you noticed from the title, it’s based on ElasticSearch.</p></div></div></section><section name="42ec" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="a501" id="a501" class="graf graf--p graf--leading">Let’s talk about the key points that contribute to making a great search module.</p><ul class="postList"><li name="b54e" id="b54e" class="graf graf--li graf-after--p">ES Tokenizers</li><li name="f83c" id="f83c" class="graf graf--li graf-after--li">Multimatch is a preference</li><li name="13fc" id="13fc" class="graf graf--li graf-after--li">Fuzzy logic</li><li name="2772" id="2772" class="graf graf--li graf-after--li">Relevancy factors<br> — Term frequency<br> — Invers Document frequency<br> — NormLength</li></ul><h3 name="7ed0" id="7ed0" class="graf graf--h3 graf-after--li">ES Tokenizers</h3><p name="fa14" id="fa14" class="graf graf--p graf-after--h3">As you know each field has an analyzer in ES, those analyzers are made of Tokenizers and Filters. Making sure those are chosen in a way that it can help the search become better is essential.<br>in the case of suggestions, one of the best results can be achieved by using an <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-edgengram-tokenizer.html" data-href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-edgengram-tokenizer.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Edge NGram Tokenizer</a>. what is Edge <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-ngram-tokenizer.html" data-href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-ngram-tokenizer.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">NGram</a>?</p><blockquote name="7825" id="7825" class="graf graf--blockquote graf-after--p">The edge_ngram tokenizer first breaks text down into words <br>whenever it encounters one of a list of specified characters, then it emits N-grams of each word where the start of the N-gram is anchored to the beginning of the word.</blockquote><p name="05c9" id="05c9" class="graf graf--p graf-after--blockquote">which brings the question what is Ngram? <br>it’s basically taking all adjacent tokens of your token with a specified length N of grams.</p><p name="f9bb" id="f9bb" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">ex. “Quick Foxes” with 3grams will give the tokens as below<br>[ Qui, uic, ick, Fox, oxe, xes ]</em></p><p name="caa7" id="caa7" class="graf graf--p graf-after--p">Edge Ngram, will be something like NGram but only tokenize from the beginning.</p><p name="6445" id="6445" class="graf graf--p graf-after--p">Using Edge Ngram gives a plus where your query will match better results while the user is providing more data. let’s say you type Nik then it will go and match the token Nik from both Nikon and Nike, of course when u give ‘e’ it will match only Nike in that case.</p><p name="81b5" id="81b5" class="graf graf--p graf-after--p">To check how your fields are tokenized for a certain document, you can use this in ES:</p><p name="dc1d" id="dc1d" class="graf graf--p graf-after--p">GET <a href="https://iprice:fGcXoXcBtYaWfUpE@es-qa.ipricegroup.com:443/content_my/filtered/bead77bb54613b1aad10d41411ef7cd937cd23cf/_termvectors?fields=name" data-href="https://iprice:fGcXoXcBtYaWfUpE@es-qa.ipricegroup.com:443/content_my/filtered/bead77bb54613b1aad10d41411ef7cd937cd23cf/_termvectors?fields=name" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener" target="_blank">Host/index_name/type/bead7_documentID_cd23cf/_termvectors?fields=fieldName</a></p><p name="6aa7" id="6aa7" class="graf graf--p graf-after--p">This will show you how many tokens you have and how are they constructed for a certain field name (your search field basically).</p><h3 name="68cf" id="68cf" class="graf graf--h3 graf-after--p">Multimatch is a preference</h3><p name="d5bd" id="d5bd" class="graf graf--p graf-after--h3">As a query, there are no musts, but a ‘match’ or <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html" data-href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">‘multi_match’</a> queries are proven to be the best in the search scenarios. ‘multi_match’ would be used in case you’re looking in multiple fields and the default type of search would be ‘best-match’ where either of the fields provided matches, the document will be a match.<br>but let’s say you want your searched keyword to be found in a combination of fields combined together (i.e. brand/model/series). in that case, you should use ‘match’ query with the type <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#type-cross-fields" data-href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#type-cross-fields" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">cross_fields</a> for search [do note that using cross_fields will cause you not to be able to use Fuzzy-logic with this as mentioned below].</p><h3 name="9909" id="9909" class="graf graf--h3 graf-after--p">Fuzzy Logic</h3><p name="0bc7" id="0bc7" class="graf graf--p graf-after--h3"><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html#query-dsl-match-query-fuzziness" data-href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html#query-dsl-match-query-fuzziness" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Fuzzy logic</a> is a very simple feature to use, but it gives a huge impact on your search.</p><p name="bdf2" id="bdf2" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">let’s show the usage in an example</strong>:<br>If the user searches for <strong class="markup--strong markup--p-strong">‘Nile’</strong> in the platform, ElasticSearch would definitely know that he meant ‘Nike’ but a type happened or a cat jumped on the keyboard. Nike will be a match of course. Cool, right!<br>But do note that this cannot be used with all types of match queries search (ex. cross_fields), but with most of them it does.</p><h3 name="2c27" id="2c27" class="graf graf--h3 graf-after--p">Relevancy factors</h3><p name="7470" id="7470" class="graf graf--p graf-after--h3">ES has some theories on what effects relevancy (since the search engine wasn’t done by them, it was <a href="https://lucene.apache.org/" data-href="https://lucene.apache.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Lucene</a>’s).</p><p name="0e8c" id="0e8c" class="graf graf--p graf-after--p">3 of the main factors are to be considered while you’re making your structure</p><h4 name="4882" id="4882" class="graf graf--h4 graf-after--p">Term frequency</h4><p name="282a" id="282a" class="graf graf--p graf-after--h4">How many tokens contain the word that is looked for in that document. and the value affects the resulted relevancy as below:<br>if(t in d) = √frequency <br>So, if your tokens are not tokenized properly you might end up having a problem in the perfect matching.<br>ex. let’s say your tokenizer is doing this:<br>a/b/c =&gt; a, a/b, a/b/c <br>This will result in having a repeated 3 times, which gives it a higher weight that matching with a document that has only ‘a’ as a value (which is a perfect match).</p><h4 name="7411" id="7411" class="graf graf--h4 graf-after--p">Inverse Document frequency</h4><p name="c9d9" id="c9d9" class="graf graf--p graf-after--h4">Well for this part, all I can say is that you should know the more you have the certain keyword in your total documents, this keyword loses value. and this was done in ES/Lucene to make sure unnecessary stop words like ‘the’,’in’ are not taken into consideration mostly. so, build your data with that in mind.</p><h4 name="7db0" id="7db0" class="graf graf--h4 graf-after--p">NormLength</h4><p name="fddf" id="fddf" class="graf graf--p graf-after--h4">This one basically is the length of your field’s value, if you don’t really care for this much to be a priority (which affects the perfect match again), then disable it and you’ll notice a significant memory improvement since this takes a byte for each doc.<br>but, it’s not advisable at all to disable this for search features. if you have a log index though, you definitely should disable it if your field is analyzed because in log indices you only care about finding an error code, but you don’t care about other stuff, plus you’ll have a big memory save.</p><h4 name="4dc6" id="4dc6" class="graf graf--h4 graf-after--p">How to check whats effecting what:</h4><p name="1445" id="1445" class="graf graf--p graf-after--h4">To check whats affecting your query not to be relevant enough, use [<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-explain.html" data-href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-explain.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">explain</a>] in your query to see what are the TF, IDF and other factors and what are their values.</p><p name="0b0f" id="0b0f" class="graf graf--p graf-after--p">It will give you something similar to this:</p><p name="0617" id="0617" class="graf graf--p graf-after--p">ex. ‘nike’ match</p><figure name="c5d0" id="c5d0" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 816px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 116.6%;"></div><img class="graf-image" data-image-id="1*iicLpB-LmIc53zRpllqa3g.png" data-width="1096" data-height="1278" src="https://cdn-images-1.medium.com/max/800/1*iicLpB-LmIc53zRpllqa3g.png"></div></figure><h3 name="e70f" id="e70f" class="graf graf--h3 graf-after--figure">Conclusion</h3><p name="09c5" id="09c5" class="graf graf--p graf-after--h3 graf--trailing">Search and suggestions are very big topics to be discussed, and this article definitely didn’t cover 1% of that subject. but, based on my experience those key points are very solid keys to base search upon.<br>Hope this was useful to the reader.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@abidul.rmdn" class="p-author h-card">Abidul Ramadan</a> on <a href="https://medium.com/p/55f8d068f316"><time class="dt-published" datetime="2017-08-20T13:46:30.210Z">August 20, 2017</time></a>.</p><p><a href="https://medium.com/@abidul.rmdn/elasticsearch-search-suggestions-best-practices-55f8d068f316" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 28, 2019.</p></footer></article></body></html>